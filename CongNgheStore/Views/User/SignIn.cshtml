@model CongNgheStore.Models.ViewModel.SignInVM

@{
    ViewBag.Title = "Đăng nhập";
    Layout = "~/Views/Shared/_SignUp_Layout.cshtml";
}

<div class="container">
    <div class="message">
        <span id="message">
            
        </span>
    </div>
    <h3 class="col d-flex justify-content-center">Đăng nhập</h3>

    <hr />
    <div class="row">
        <div class="col-md-12">
            <form onsubmit="return false">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <div class="form-group">
                    <label asp-for="PhoneNumber" class="control-label" >Số điện thoại: </label>
                    <input  oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" asp-for="PhoneNumber" class="form-control" placeholder="Test: 0900200200"/>
                    <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Password" class="control-label">Mật khẩu: </label>
                    <input type="password" asp-for="Password" class="form-control" placeholder="User@123"/>
                    <span asp-validation-for="Password" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <div class="custom-checkbox">
                        <label asp-for="RememberMe">
                            <input asp-for="RememberMe" />
                            Ghi nhớ đăng nhập
                        </label>
                    </div>
                </div>

                <input asp-for="RoleName" hidden />

                <div class="form-group col d-flex justify-content-center">
                    <button type="submit" class="btn btn-success">Đăng nhập</button>
                </div>
            </form>
        </div>
    </div>

    <div>
        <a asp-controller="Home" asp-action="Index">Trang chủ</a>
        <span class="text-primary">|</span>
        <a asp-action="SignUp">Bạn chưa có tài khoản?</a>       
    </div>
</div>

<script>
    $(document).ready(function () {
        var urlApi = 'https://localhost:44311/api/';
        var urlApiSignIn = urlApi + 'Account/SignIn';
            
        $('button[type=submit]').click(async function(){

            var dataApiSignIn = {
                phoneNumber: $('#PhoneNumber').val(),
                password: $('#Password').val(),
                rememberMe: $('#RememberMe').is(':checked'),
                roleName: $('#RoleName').val()
            };

            await sendRequest(urlApiSignIn, dataApiSignIn, 'post');
        });

        function message(value) {
            $('#message').html(value);
            $('#message').css('display','inline-block');
            $('#message').addClass('bg-danger');
            $('#message').fadeIn('slow');
            setTimeout(function() {
                $('#message').fadeOut('slow');
            }, 3000);
        }

        function sendRequest(url, data, method) {
            $.ajax({
                url: url,
                async: false,
                data: JSON.stringify(data),
                error: function(response) {
                    message('Đăng nhập không thành công!');
                },
                success: function(response) {

                    if (response.Success == true) {
                        //luu token vao localStorage
                        window.localStorage.setItem('token', response.Data);

                        window.sessionStorage.setItem('message', 'Đăng nhập thành công!');

                        //lay data trong payload cua token
                        function decodeJwt(token) {
                            var base64Url = token.split('.')[1];
                            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                            }).join(''));

                            return JSON.parse(jsonPayload);
                        }

                        var payload = decodeJwt(response.Data);
                        var role = payload['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'];
                        //neu role user tra ve home
                        if(role == 'User') window.location.href = '/';

                        //neu role admin tra ve admin/home
                        if(role == 'Admin') window.location.href = 'Admin/Home'
                    }
                    else message(response.Message);
                },
                type: method,
                headers: {'Content-Type': 'application/json'},
                contentType: 'application/json; charset=utf-8',
                dataType: 'json'
            });
        }
    
    });
</script>